<!doctype html>
<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
<title>stream-rpc</title>
<link rel="stylesheet" href="_static/default.css" type="text/css" />
<script src="_static/jquery.js"></script>
<script src="_static/jquery.lettering.js"></script>
<script>
  $(function() {
    var $headers = $('h1');
    $headers.lettering('words').children('span').lettering();
    $headers.children('span').children('span:contains("¶")').remove();
  });
</script>
<div class="main">
  
  <div class="section" id="stream-rpc">
<h1>Stream-RPC<a class="headerlink" href="#stream-rpc" title="Permalink to this headline">¶</a></h1>
<p>RPC calls over arbitrary streams in Node and a Browser</p>
<p>This library provides a way to send a request and get a response on it over
an arbitrary stream. It works both in Node and in a browser (via <a class="reference external" href="http://browserify.org">browserify</a>).</p>
<p>This documentation is organized as follows:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><a class="reference internal" href="#getting-started" id="id1">Getting started</a></li>
<li><a class="reference internal" href="#rpc-over-websockets" id="id2">RPC over WebSockets</a></li>
<li><a class="reference internal" href="#handling-timeouts" id="id3">Handling timeouts</a></li>
<li><a class="reference internal" href="#development" id="id4">Development</a></li>
</ul>
</div>
<p>Note that this is not a full-blown RPC solution but a just primitive building
block which correlates request with corresponding response over streams.</p>
<div class="section" id="getting-started">
<h2><a class="toc-backref" href="#id1">Getting started</a><a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>To get started, install <tt class="docutils literal"><span class="pre">stream-rpc</span></tt> package via <tt class="docutils literal"><span class="pre">npm</span></tt>:</p>
<div class="highlight-python"><pre>% npm install stream-rpc</pre>
</div>
<p>After that you will be able to use <tt class="docutils literal"><span class="pre">stream-rpc</span></tt> library in your code.  The
basic usage example is as follows:</p>
<div class="highlight-python"><pre>var rpc = require('stream-rpc'),
    client = rpc(),
    server = rpc({
      handle: function(request, done) {
        done(null, 'Hello, ' + request.name + '!');
      }
    });

client.pipe(server).pipe(client);

client.call({name: 'World'}, function(response) {
  console.log(response); // prints 'Hello, World!'
});</pre>
</div>
<p>Note that in the example above <tt class="docutils literal"><span class="pre">client</span></tt> and <tt class="docutils literal"><span class="pre">server</span></tt> streams are connected
directly, while in a real-world scenario you probably would like them to be
connected over the network.</p>
</div>
<div class="section" id="rpc-over-websockets">
<h2><a class="toc-backref" href="#id2">RPC over WebSockets</a><a class="headerlink" href="#rpc-over-websockets" title="Permalink to this headline">¶</a></h2>
<p>Now, we will provide an example of an RPC subsystem over WebSockets. For that we
need <a class="reference external" href="https://github.com/maxogden/websocket-stream">websocket-stream</a> library which wraps WebSocket (both client and
server) connection in a stream.</p>
<p>We also need a way to serialize values inside streams, let&#8217;s do it in a plain
JSON:</p>
<div class="highlight-python"><pre>var through = require('through');

var serialize = function() {
  return through(function(data) {
    this.push(JSON.stringify(data));
  });
};

var deserialize = function() {
  return through(function(data) {
    this.push(JSON.parse(data));
  });
};</pre>
</div>
<p>Please note <a class="reference external" href="https://github.com/dominictarr/through">through</a> library which we use to create <tt class="docutils literal"><span class="pre">serialize</span></tt> and
<tt class="docutils literal"><span class="pre">deserialize</span></tt> stream transformers.</p>
<p>On a server you need to compose a stream pipeline on each connection:</p>
<div class="highlight-python"><pre>var websocket = require('websocket-stream'),
  rpc = require('stream-rpc'),
  ws = require('ws'),
  wss = new ws.Server({port: 3000}),
  handle = function(request, done) {
    // process request
    done(null, {msg: 'hello, ' + request.name + '!'});
  };

wss.on('connection', function(ws) {
  var sock = websocket(ws),
      server = rpc({handle: handle});
  server
    .pipe(serialize())
    .pipe(sock)
    .pipe(deserialize())
    .pipe(server);
});</pre>
</div>
<p>Now on a client you use exactly the same libraries and exactly the same:</p>
<div class="highlight-python"><pre>var websocket = require('websocket-stream'),
    rpc = require('stream-rpc'),
    sock = websocket('ws://localhost:3000'),
    client = rpc();

client
  .pipe(serialize())
  .pipe(sock)
  .pipe(deserialize())
  .pipe(client);

sock.on('open', function() {
  client.call({name: 'andrey'}, function(err, response) {
    console.log(response.msg); // 'hello, andrey!'
  });
});</pre>
</div>
<p>Note that you would need to process client code with <tt class="docutils literal"><span class="pre">browserify</span></tt> before
serving to a browser.</p>
</div>
<div class="section" id="handling-timeouts">
<h2><a class="toc-backref" href="#id3">Handling timeouts</a><a class="headerlink" href="#handling-timeouts" title="Permalink to this headline">¶</a></h2>
<p>Library also provides a way to handle timeouts, just pass a <tt class="docutils literal"><span class="pre">timeout</span></tt> option
in milliseconds to a client:</p>
<div class="highlight-python"><pre>var client = rpc({timeout: 2000});</pre>
</div>
<p>If <tt class="docutils literal"><span class="pre">client</span></tt> waits more than 2 seconds then it will receive <tt class="docutils literal"><span class="pre">new</span>
<span class="pre">Error('timeout')</span></tt> error.</p>
</div>
<div class="section" id="development">
<h2><a class="toc-backref" href="#id4">Development</a><a class="headerlink" href="#development" title="Permalink to this headline">¶</a></h2>
<p>Development of the library takes place in the  GitHub <a class="reference external" href="https://github.com/andreypopp/stream-rpc">andreypopp/stream-rpc</a>
repository.</p>
<p>Before submitting any pull requests please make sure with <tt class="docutils literal"><span class="pre">make</span> <span class="pre">test</span></tt> that all
tests pass.</p>
</div>
</div>


  <footer>
    <p>stream-rpc 0.1.1</p>
    <p>Generated using Sphinx 1.2b1</p>
  </footer>
</div>
</div>
<a class="github-ribbon" href="https://github.com/andreypopp/stream-rpc">
  <img src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub">
</a>